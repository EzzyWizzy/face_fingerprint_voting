<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Voting System</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
    crossorigin="anonymous"></script>


</head>

<body class="bg-light">
  <div class="container mt-5">
    <div class="card">
      <div class="card-header">
        <h4 class="text-center">TANZANIA ELECTRONIC VOTING SYSTEM </h4>
      </div>
      <div class="card-body">
        
        <div class="row p-3 bg-light">



          <div class="col-lg-12">
            <div class="row">
              <div class="col-lg-12 p-3 text-success">Server Status: <span id="serverStatus">Not connected </span></div>
              <hr>

            </div>
            <ul class="nav justify-content-center">
              <li class="nav-item">
                <a class="nav-link active" href="../static/">VOTE</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="../static/register.html">REGISTER</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="../static/admin.html">LOGIN</a>
              </li>
            </ul>







            <form action="">
              <div class="multiple_section" id="section_1" style="display:block">

                <div class="mb-3 mt-3 p-3 bg-secondary">
                  <div class="row">
                    <div class="col-md-12 ">

                      <div class="card p-2">
                        <!-- <div class="input-group mb-3 mt-3">
                        <input type="number" class="form-control" id="input_Id" placeholder="Enter finger id (1-127)">
                        <div class="input-group-append">
                          <button class="btn btn-secondary" type="submit">Send</button>
                        </div>
                      </div>  -->

                        <h4 class="p-3">Finger Print Verification</h4>
                        <button type="button" class="start-button btn btn-warning" id="start-fingerprint">Start</button>

                        <div class=" p-3 mb-2  bg-danger text-light text-center" style="height: 200px; ">
                          <h3 id="finger-print-status">
                            <div class="spinner-grow spinner-grow-lg text-warning"></div>

                          </h3>
                          <p id="fingerid" class="text-danger"></p>
                        </div>


                      </div>
                    </div>

                  </div>

                </div>



                <button type="button" id="sec_1" class="btn btn-primary next-prev"
                  data-next-prev="section_2">Next</button>
              </div>
              <div class="multiple_section" id="section_2">
                <div class="mb-3 mt-3 p-3 bg-secondary">
                  <div class="row">

                    <div class="col-md-12 ">
                      <div class="card p-2">
                        <h4 class="p-3">Face Recognition</h4>
                        <button type="button" class="start-button btn btn-warning" id="start-face">Start</button>
                        <div class=" p-3 bg-danger text-light text-center" style="height: 200px; ">
                          <h3 id="face-status" style="margin-top: 50px; ">
                            <div class="spinner-grow spinner-grow-lg text-warning"></div>
                          </h3>
                        </div>

                      </div>
                    </div>
                  </div>

                </div>


                <button type="button" id="sec_2" class="btn btn-primary next-prev"
                  data-next-prev="section_1">Prev</button>
                <button type="button" id="sec_3" class="btn btn-primary next-prev"
                  data-next-prev="section_3">Next</button>
              </div>
              <div class="multiple_section" id="section_3">
                <div class="mb-3 mt-3 p-3 bg-secondary">
                  <div class="row">
                    <div class="col-lg-12">
                      <div class="row">
                        <p><b>CANDIDATES</b></p>
                        <div class="col-sm-4">
                          <div class="card">
                            <img src="img/ccm.png" class="card-img-top w-25 mx-auto d-block mt-2" alt="candidate">
                            <div class="card-body">
                              <h4 class="card-title">Samia Hassan Suluhu</h4>
                              <p class="card-text">CCM</p>
                              <button type="button" class="btn btn-warning" id="vote-ccm">SELECT</button>
                            </div>
                          </div>
                        </div>
                        <div class="col-sm-4">
                          <div class="card">
                            <img src="img/chadema.png" class="card-img-top w-25 mx-auto d-block mt-2" alt="candidate">
                            <div class="card-body">
                              <h4 class="card-title">Tundu Antipas Lissu</h4>
                              <p class="card-text">CHADEMA</p>
                              <button type="button" class="btn btn-danger" id="vote-cdm">SELECT</button>
                            </div>
                          </div>
                        </div>
                        <div class="col-sm-4 ">
                          <div class="card h-100">
                            <img src="img/act.png" class="card-img-top w-25 mx-auto d-block mt-2" alt="candidate">
                            <div class="card-body">
                              <h4 class="card-title">Zitto Kabwe</h4>
                              <p class="card-text">ACT WAZALENDO</p>
                              <button type="button" class="btn btn-primary" id="vote-act">SELECT</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <button type="button" id="sec_4" class="btn btn-primary next-prev"
                  data-next-prev="section_2">Prev</button>
                <button type="button" id="sec_5" class="btn btn-primary next-prev"
                  data-next-prev="section_4">Next</button>
              </div>
              <div class="multiple_section" id="section_4">
                <div class="mb-3 mt-3 p-3 bg-danger">
                  <div class="row">
                    <div class="col-lg-12 text-center " style="height: 100px; ">
                      <button type="button" id="vote-candidate" class="btn btn-primary mt-3">Vote</button>
                    </div>
                  </div>
                </div>

                <button type="button" id="sec_6" class="btn btn-primary next-prev"
                  data-next-prev="section_3">Prev</button>
                <button type="button" id="sec_7" class="btn btn-primary next-prev"
                  data-next-prev="section_5">Next</button>
              </div>
              <div class="multiple_section" id="section_5">
                <div class="mb-3 mt-3 p-3 bg-secondary">
                  <div class="row">
                    <div class="col-lg-12">
                      <div class="card">
                        <div class="card-header">
                          <h4 class="text-center">VOTING STATUS </h4>
                        </div>
                        <div class="card-body">
                          <div class=" card bg-light p-5 text-center" id="votestatus">

                          </div>
                          <a href="resultpage.html" class="btn btn-warning w-100">VIEW RESULT</a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <button type="button" id="sec_8" class="btn btn-primary next-prev"
                  data-next-prev="section_4">Prev</button>
                <button type="button" id="sec_9" class="btn btn-primary">Close</button>
              </div>
            </form>
          </div>




        </div>
      </div>
    </div>
    <div class="card-footer text-center mb-3">
      <div class="row">
        <div class="col-sm-4">
          <p> Admin must login here</p>
        </div>
        <div class="col-sm-8">
          <form class="form-inline">
            <div class="row">
              <div class="col-sm-4">
                <div class="form-group">
                  <input type="email" class="form-control" id="email" placeholder="Enter Email">
                </div>
              </div>
              <div class="col-sm-4">
                <div class="form-group">
                  <input type="password" class="form-control" id="pwd" placeholder="Enter Password">
                </div>
              </div>
              <div class="col-sm-4">
                <button type="button" class="btn btn-primary" id="login">Login</button>
              </div>
            </div>
          </form>
        </div>
      </div>
      <p>FINGER ID: <span id="id_txt"></span>
        FACE ID: <span id="face_txt"></span></p>
      <p>@DIT Fingerprint and Facial Recognition Voting Syatem</p>
    </div>
  </div>


  <script>
    var socket = new WebSocket('ws:localhost:5555/ws');
    var finger_status = document.getElementById('finger-print-status');
    var start_fingerprint = document.getElementById('start-fingerprint');
    var start_face = document.getElementById('start-face');
    var input_name = document.getElementById('input_name');
    var voteccm = document.getElementById("vote-ccm");
    var votebtn=document.getElementById("vote-candidate");
    var votecdm = document.getElementById("vote-cdm");
    var voteact = document.getElementById("vote-act");

    var sec_1 = document.getElementById("sec_1");
    var sec_2 = document.getElementById("sec_2");
    var sec_3 = document.getElementById("sec_3");
    var sec_4 = document.getElementById("sec_4");
    var sec_5 = document.getElementById("sec_5");
    var sec_6 = document.getElementById("sec_6");
    var sec_7 = document.getElementById("sec_7");
    var sec_8 = document.getElementById("sec_8");
    var voterName = "";
    $("#sec_1").prop("disabled", true);
    $("#sec_2").prop("disabled", true);
    $("#sec_3").prop("disabled", true);
    $("#sec_4").prop("disabled", true);
    $("#sec_5").prop("disabled", true);
    $("#sec_6").prop("disabled", true);
    $("#sec_7").prop("disabled", true);
    $("#sec_8").prop("disabled", true);


    var fingerId = "";
    var vote = 0;
    var party = "";
    var faceId = "";

    var server_status = document.getElementById('serverStatus');
    $(document).ready(function () {
      $(".next-prev").click(function () {
        var section = $(this).attr("data-next-prev");
        $(".multiple_section").css("display", "none");
        $("#" + section).css("display", "block");
      });
    });
    $("#vote-ccm").prop("disabled", true);
    $("#vote-cdm").prop("disabled", true);
    $("#vote-act").prop("disabled", true);
    socket.onopen = function () {
      console.log('Connected to server');
      $('#serverStatus').html('Server Connected');

    };
    let fc_id = "";
    let fg_id = "";
    let flag=false;
    let isBtnClicked =false;
    socket.onmessage = function (event) {
      var data = JSON.parse(event.data);
      fingerId = data.id;
      var message = data.command;
      var faceDetails = data.face_status;
      $('#id_txt').html(fingerId);
      $('#face_txt').html(faceDetails);
      fg_id = $('#id_txt').text();
      fc_id = $('#face_txt').text();
      console.log('finger: ' + fg_id)
      console.log('face: ' + fc_id)
      console.log(faceDetails);
      console.log('Voter Name: ' + voterName);


      var f = $('#face-status').text();
      var i = $('#finger-print-status').text();

      if (f != '' && i != '') {
        f = f.replace(/\s+/g, '');
        i = i.replace(/\s+/g, '');
        if(isBtnClicked){
          if (f == i) {
            $('#face-status').html('Found Name: '+voterName+"");
            $("#sec_3").prop("disabled", false);
            $("#sec_4").prop("disabled", false);
            $("#sec_5").prop("disabled", false);
            $("#vote-ccm").prop("disabled", false);
            $("#vote-cdm").prop("disabled", false);
            $("#vote-act").prop("disabled", false);
            flag=true;
          } else {
            if(!flag){
              $('#face-status').html(faceDetails);
            }
        }
        
         
        }
      }
      

      $('#finger-print-status').html(message);
      $("input:text").val(fingerId);

      $('#fingerid').html(fingerId);


      if ((message == "Success" && fingerId != "") || message == "exists") {
        setTimeout(function () {

          fingerId = $("#fingerid").text();
          $("#sec_1").prop("disabled", true);
          // $("#fin").html(fingerId);

          $.ajax({
            type: "POST",
            url: "http://192.168.12.191/face_fingerprint_voting/static/actionpages/checkfingerId.php",
            data: {
              fingerId: fingerId,
            },
            cache: false,
            success: function (data) {

              if (data == 'Not found') {
                $('#finger-print-status').html("Cannot find this id in database");
                $("#sec_1").prop("disabled", true);
              } else {
                voterName = data;
                $('#finger-print-status').html(data);
                voterName = $('#finger-print-status').text();

                $("#sec_1").prop("disabled", false);
                $("#sec_2").prop("disabled", false);

              }
            },
            error: function (xhr, status, error) {
              $("#sec_1").prop("disabled", true);

            }
          });
        }, 1000);
      } else {

      }




    }
    votebtn.addEventListener('click',function(){
      if(party != ""){
        voting(party);
      }else{
        alert("You must select party")
      }
     
    })
    voteccm.addEventListener('click', function () {
      party = "ccm";
      
      $("#vote-ccm").prop("disabled", true);
      $("#vote-cdm").prop("disabled", true);
      $("#vote-act").prop("disabled", true);
      party = "";
    });
    votecdm.addEventListener('click', function () {
      party = "chadema";
      
      $("#vote-ccm").prop("disabled", true);
      $("#vote-cdm").prop("disabled", true);
      $("#vote-act").prop("disabled", true);
      
    });
    voteact.addEventListener('click', function () {
      party = "act";
      
      $("#vote-ccm").prop("disabled", true);
      $("#vote-cdm").prop("disabled", true);
      $("#vote-act").prop("disabled", true);
     
    });

    $('#login').click(function (e) {
      var email = $("#email").val();
      var pwd = $("#pwd").val();

      if (email == '' || pwd == '') {
        alert("Fill all information");
      } else if (email == 'happy@gmail.com' && pwd == '12345') {
        window.location.replace("admin.html");
      } else {
        alert("Provided information is incorrect");
        $("#pwd").val('');
        $("#email").val('');


      }

    });

    start_fingerprint.addEventListener('click', function () {
      socket.send("f");

    });
    start_face.addEventListener('click', function () {
      $('#face-status').html('Initializing camera...');
      socket.send("u");
      isBtnClicked=true;
    });

    socket.onclose = function () {
      console.log('Network Disconneted');
      $('#serverStatus').html('Server Disconneted');
    };

    function voting(party) {
      var ccm = 0;
      var cdm = 0;
      var act = 0;

      if (party == "chadema") {
        cdm = 1;
      }
      if (party == "ccm") {
        ccm = 1;
      }
      if (party == "act") {
        act = 1;
      }
      if (fingerId == "") {
        alert("Finger Id is not given");
        return;
      } else {
        $.ajax({
          type: "POST",
          url: "http://192.168.12.191/face_fingerprint_voting/static/actionpages/vote.php",
          data: {
            ccm: ccm,
            cdm: cdm,
            act: act,
            fingerId: fingerId,
            faceId: faceId
          },
          cache: false,
          success: function (data) {
            alert(data);
            if (data == "success") {
              $('#votestatus').html('<p class="text-success"><i class="fas fa-check h2"></i> <p class="text-success">Voted Succesful</p></p>')

            } else {

              $('#votestatus').html('<p class="text-danger"><i class="fas fa-window-close h2"></i> <p class="text-danger">' + data + '</p></p>')

            }
          },
          error: function (xhr, status, error) {
            $('#votestatus').html('<p class="text-danger"><i class="fas fa-window-close h2"></i> <p class="text-danger">' + data + '</p></p>')

          }
        });
      }
    }
  </script>

</body>

</html>